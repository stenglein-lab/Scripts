#!/usr/bin/perl

use strict;


my $usage = <<USAGE;

  Quantify frequency of mismatches and indels from a SAM format file
  generated by bowtie2 or some aligner that outputs the XM and XO tags

  Mark Stenglein, 6.29.2012

  usage: $0 <sam_file>

USAGE

if (scalar (@ARGV) == 0) { print $usage and exit; }

my @fields = ();
my @tags = ();
my $length_sum = 0;
my $mm_sum = 0;
my $gap_sum = 0;

while (<>)
{
   chomp;
   
   if (/^@/)
   {
      next;
   }

   @fields = split "\t";
   if ($fields[9] eq '*')
   {
      # could calc length from CIGAR string but not implemented
      die "sequence necessary but not reported"; 
   }
   $length_sum += length($fields[9]);

   my $num_fields = scalar (@fields);
   @tags = @fields[11 .. ($num_fields-1) ];
   # print "tags: @tags\n";
   foreach (@tags)
   {
      # print "$_\n";
      if (/XM:i:([-+]?[0-9]+)/)
      {
         $mm_sum += $1;
         # print "$_\t$1 mismatches\n";
      }
      elsif (/XO:i:([-+]?[0-9]+)/)
      {
         $gap_sum += $1;
         # print "$_\t$1 gaps\n";
      }
   }
}

my $gap_freq = $gap_sum / $length_sum;
my $mm_freq = $mm_sum / $length_sum;

print "total bases\tgaps\tmismatches\tgap-freq\tmismatch-freq\n";
print "$length_sum\t$gap_sum\t$mm_sum\t$gap_freq\t$mm_freq\n";
